# brickblock-backend
A basic NodeJS backend that's hosting mock ICO offering data on MongoDB using GraphQL to interact with the data.


## Deployment
There are two deployed environments 

For development: https://brickblock-backend-develop.herokuapp.com/graphql

For production: https://brickblock-backend.herokuapp.com/graphql
```
WARNING
As the application is deployed using the free heroku service they will sleep due to inactivity. 
Please allow a short while for the app to build and serve if you get no response from the URL.
```


## Prerequisites
1. [NodeJS](https://nodejs.org/)
2. [MongoDB](https://docs.mongodb.com/manual/administration/install-community/)
3. Alternatively to MongoDB you can use [Docker](https://docs.docker.com/install/)

## Setup
1. Create `.env` in the root of the project and fill in the appropriate config. A sample can be found in `.env.example`
```
PORT=8000
MONGODB_URI=mongodb://localhost:27017/sample
LOG_LEVEL_CONSOLE=debug
LOG_LEVEL_FILE=info
SENTRY_LOG_LEVEL=info
SENTRY_DNS=https://sample@sentry.io/sample
TEST_API_URL=http://localhost:8000/graphql
```
2. Run `mongod` if you setup MongoDB locally to start your local MongoDB instance
3. Or else run `docker pull mongo` then `docker run -p 27017:27017 mongo` to run it on Docker
4. Run `npm install` to install the dependencies
5. Run `npm run mock:data` to generate mock ICO data and populate the database specified in your `MONGODB_URI` .env variable


## Quickstart
Run the server locally as follows:

```
npm start
```

The project should now be available at `http://localhost:8000/graphql`
If the database contains no data you can run `npm run mock:data` to populate it with mock ICO data

## Project Scaffolding
The `src` directory contains the source code for the server. It is built using Express and the Apollo Server middleware to connect GraphQL. The `test` directory contains the source code for the tests. It is built using Mocha. The file structure of this should mimic the structure of the `src` folder with unit tests written for each file.
This source code is transpiled to the `build` directory for deployment and testing.
1. `npm run build` will transpile the `src` and `test` directories into `build`
2. `npm run clean` will delete the transpiled code

## Testing
Mocha and Chai are currently used for testing. The routes, services and GraphQL endpoints are all tested.  The logging level for the tests is set to `error` which will hide all logs except errors.
```
npm test
```

## Linting
The project is using ESLint and Prettier to lint and format the code. The configuration for this is stored in `.eslintrc.json` and `.prettierrc.json` You can use the following commands:
1. `npm run pretty` to run Prettier
2. `npm run lint` to run ESLint
3. `npm run lint:fix` to run ESLint with the --fix prefix which will automatically fix certain linting errors

## Flow
Flow is used as a lightweight static type checker
```
npm run flow
```

## Docker
There app is dockerized, and the Dockerfile builds the app in production mode for the automated deployments

## GraphQL
For a detailed look at what you can do with the graphql endpoint look at the schemas defined in: `src/services/graphql/schema`
But here are some sample queries and mutations.

## Queries
```
query {
  ICOs{
    _id # Unique ID for each item, auto generated by mongodb
    address
    currency
    value(exchange: "euro") # Possible inputs ("euro", "dollar") No input returns Satoshi, Litoshi and Mwei values. 
    txid
    date
  }
}

mutation {
  createICO(
    address: "183nLVZFt3W6G79o5Yx8bTiEBsjER9eMVZ"
    currency: "BTC"
    value: 5024114
    txid: "f6b48e20e78ed5800ca07ea2a782a14227fee043de86f88eaaebcd88d34c9650"
    date: "2019-02-09T21:55:14.839Z" # Has to be a valid date object and not a date as String
  ) {
    _id
    address
    currency
    value
    txid
    date
  }
}

query{
  ExchangeRate(currency: "BTC"){
    _id
    currency
    euro
    dollar
  }
}

mutation {
  createExchangeRate(
    currency: "ETH"
    euro: 107.43
    dollar: 121.71
  ) {
    _id
    currency
    euro
    dollar
  }
}
```


## CI/CD
[CircleCI](https://circleci.com/) is used for continuous integration and deployment.

Developers are required to work locally on a new branch. 

When making a merge request into the 'development' branch, CircleCI will trigger a 'build' job that will build the project, check linting, run flow, and run the tests. The merge request will be rejected if these checks fail.

After merging a 'deployToDevelopment' job will trigger which will deploy the app to https://brickblock-backend-develop.herokuapp.com/graphql

Only after the 'build' and 'deployToDevelopment' jobs have succsefully run will you be able to make a merge request into the 'master' branch which will trigger the final 'deployToProduction' job that will deploy the app to https://brickblock-backend.herokuapp.com/graphql

[Heroku](https://www.heroku.com/) is used for the automated deployments. CircleCI builds the Docker container and then pushes it to the heroku Docker hub and then releases the application making it visible
